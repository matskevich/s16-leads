name: Anti-spam Compliance & Security

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 02:00 UTC to catch any regression
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.9'

jobs:
  anti-spam-compliance:
    name: ğŸ›¡ï¸ Anti-spam Compliance Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit flake8 black isort yamllint
        
    - name: ğŸ” Check anti-spam compliance
      run: |
        echo "::group::Anti-spam Compliance Check"
        python scripts/check_anti_spam_compliance.py
        echo "::endgroup::"
        
    - name: ğŸ”’ Security scan with Bandit
      run: |
        echo "::group::Security Scan"
        bandit -r src/ examples/ -f json -o bandit-report.json || true
        bandit -r src/ examples/
        echo "::endgroup::"
        
    - name: ğŸ” Code linting
      run: |
        echo "::group::Code Linting"
        flake8 src/ examples/ tests/ scripts/ --max-line-length=100 --ignore=E203,W503
        echo "::endgroup::"
        
    - name: ğŸ¨ Check code formatting
      run: |
        echo "::group::Code Formatting Check"
        black --check src/ examples/ tests/ scripts/
        isort --check src/ examples/ tests/ scripts/
        echo "::endgroup::"
        
    - name: ğŸ” Comprehensive Telegram API audit
      run: |
        echo "::group::Telegram API Audit"
        make telegram-api-audit
        echo "::endgroup::"
        
    - name: ğŸ“Š Upload security report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          security-report.json
        retention-days: 30

  test-with-compliance:
    name: ğŸ§ª Tests with Compliance Verification
    runs-on: ubuntu-latest
    needs: anti-spam-compliance
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-mock pytest-asyncio
        
    - name: ğŸ§ª Run tests
      run: |
        echo "::group::Running Tests"
        PYTHONPATH=. python -m pytest tests/ -v --tb=short
        echo "::endgroup::"
        
    - name: âœ… Verify anti-spam integration
      run: |
        echo "::group::Anti-spam Integration Test"
        python -c "
        from src.infra.limiter import get_rate_limiter
        from src.core.group_manager import GroupManager, _is_testing_environment
        
        # Test rate limiter
        limiter = get_rate_limiter()
        stats = limiter.get_stats()
        print('âœ… Rate limiter working:', stats)
        
        # Test environment detection
        is_test = _is_testing_environment()
        print('âœ… Test environment detected:', is_test)
        
        print('ğŸ›¡ï¸ Anti-spam system operational!')
        "
        echo "::endgroup::"

  notification:
    name: ğŸ“¢ Compliance Status
    runs-on: ubuntu-latest
    needs: [anti-spam-compliance, test-with-compliance]
    if: always()
    
    steps:
    - name: ğŸ“¢ Report status
      run: |
        if [ "${{ needs.anti-spam-compliance.result }}" == "success" ] && [ "${{ needs.test-with-compliance.result }}" == "success" ]; then
          echo "âœ… All anti-spam compliance checks passed!"
          echo "ğŸ›¡ï¸ S16-leads is protected against Telegram API abuse"
        else
          echo "âŒ Anti-spam compliance check failed!"
          echo "ğŸš¨ Manual review required for Telegram API safety"
          exit 1
        fi